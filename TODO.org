* Format
** Considerations
*** flexible, extensible format supporting optional fields of various lengths
*** records various metadata about files and directories if available from OS
*** numeric fields are network byte order (Big Endian)
*** textual fields are UTF-8 encoded
*** may include data checksums for verification
*** XML is flexible, supports complex data types
*** JSON is smaller than XML, easy to parse
*** EXIF style is compact (rows of tuples consisting of tag, size, value)
**** ~header rows~ will consist of 2-byte tag, 2-byte size, and N bytes of value
**** overall header size and individual rows will never be longer than 64 KB
*** CBOR is very compact but dependent on finding good implementations
** Encrytion
*** password is used to derive a key using one of various algorithms, typically with a salt
*** derived key (aka secret) is used to perform symmetric-key encryption on the file data
*** directory/file header data rows are encrypted to prevent listing of archive contents
** Archive header
*** EXIF style entries after the initial version-specific rows
| Offset | Size | Purpose                        |
|--------+------+--------------------------------|
|      0 |    4 | File signature ('EXAF')        |
|      4 |    2 | format version (major/minor)   |
|      6 |    2 | remaining header size in bytes |
|      8 |    2 | optional field tag             |
|     10 |    2 | optional field size in bytes   |
|     12 |    n | optional field value           |
|    ... |  ... | ...                            |
*** fields related to encryption
| Tag  | Purpose                                   |
|------+-------------------------------------------|
| 'KD' | key derivation algorithm (i.e. Argon2id)  |
| 'SA' | random salt for encrypting password       |
| 'IT' | number of iterations depending on KDF     |
| 'EA' | encryption algorithm (AES, Blowfish, etc) |
*** 1 or more manifests of files and directories starts after header
** Archive entry considerations
*** will need to ensure that any extended attributes are less than 64 KB
*** directory entries are optional, but must appear before files that refer to them
*** duplicate directory entries are permissible for easier addition of files
** Archive entry structure
*** all file paths and names are UTF-8 encoded
*** entry date/time is ~Unix time~ (seconds since the epoch) as 32 or 64 bits
**** https://en.wikipedia.org/wiki/Unix_time
**** length of the field will be either 4 (32 bits) or 8 (64 bits)
*** integer values will be serialized to the smallest number of bytes necessary
**** e.g. values below 256 will be written as 1 byte
*** each file and directory entry will have a 2-byte size followed by header rows
*** each header row consists of 2 + 2 + N bytes (tag, size, value)
*** entry with row tag of =ID= is a directory
*** entry with row tag of =SZ= is a file
** Archive entry representing a directory
*** codifies each unique path as a numeric value for efficiency
*** file entries will refer to the containing directory by its identifier
*** fields
| Tag  | Size   | Purpose                             | Required? |
|------+--------+-------------------------------------+-----------|
| 'ID' | vary   | Unique identifier                   | yes       |
| 'NM' | vary   | name of directory                   | yes       |
| 'PA' | vary   | parent path as UTF-8                |           |
| 'MO' | vary   | Unix mode                           |           |
| 'FA' | vary   | Windows file attributes             |           |
| 'MT' | 4 or 8 | modification date/time as Unix time |           |
| 'CT' | 4 or 8 | creation date/time as Unix time     |           |
| 'AT' | 4 or 8 | access date/time as Unix time       |           |
| 'XA' | vary   | Extended file system attributes     |           |
| 'UN' | vary   | name of FS owner                    |           |
| 'UI' | vary   | user identifier                     |           |
| 'GN' | vary   | name of FS group                    |           |
| 'GI' | vary   | group identifier                    |           |
*** example entry
| Tag  | Size | Value                        |
|------+------+------------------------------|
| 'MO' |    2 | 0o40755                      |
| 'ID' |    2 | 16344                        |
| 'PA' |   28 | node_modules/saml2-js/lib-js |
| 'MT' |    4 | 0x6604C3BF                   |
| 'UN' |    8 | nfiedler                     |
| 'UI' |    2 | 501                          |
| 'GN' |    5 | staff                        |
| 'GI' |    1 | 20                           |
** Archive entry representing a file
*** fields
| Tag  | Size   | Purpose                             | Required? |
|------+--------+-------------------------------------+-----------|
| 'NM' | vary   | name of file                        | yes       |
| 'DI' | vary   | directory identifier                |           |
| 'MO' | vary   | Unix mode                           |           |
| 'FA' | vary   | Windows file attributes             |           |
| 'HA' | vary   | hash digest algorithm               |           |
| 'CS' | vary   | hash digest of original data        |           |
| 'MT' | 4 or 8 | modification date/time as Unix time |           |
| 'CT' | 4 or 8 | creation date/time as Unix time     |           |
| 'AT' | 4 or 8 | access date/time as Unix time       |           |
| 'XA' | vary   | Extended file system attributes     |           |
| 'UN' | vary   | user name                           |           |
| 'UI' | vary   | user identifier                     |           |
| 'GN' | vary   | group name                          |           |
| 'GI' | vary   | group identifier                    |           |
*** example entry
| Tag  | Size | Value            |
|------+------+------------------|
| 'NM' |   16 | take_snapshot.rs |
| 'DI' |    2 | 16344            |
| 'MO' |    2 | 0o100644         |
| 'MT' |    4 | 0x6604C3BF       |
| 'UN' |    8 | nfiedler         |
| 'UI' |    2 | 501              |
| 'GN' |    5 | staff            |
| 'GI' |    1 | 20               |
* Action Plan
** TODO consider how to distinquish files from symbolic links
** DONE consider how to batch compress many files like pack does
*** fill a block with file content, compress, write the manifest, then compressed data
*** manifest is like =itemcontent= from pack which maps file data into content blocks
*** files that do not fit into a single block will continue in the next block
*** if ~itempos~ is non-zero, file metadata will not be serialized to the block
*** zero-length files have a =SZ= of =0= and no data in the block
*** manifest header structure
**** 2-byte size of the header in bytes followed by header rows
**** fields
| Tag  | Size | Description                     |
|------+------+---------------------------------|
| 'NE' | vary | number of entries in this block |
| 'CA' | vary | compression algorithm ('ZSTD')  |
| 'BS' | vary | block size in bytes             |
**** file/directory entries follow (2-byte entry size, header rows)
**** additional tags for stored content (files and symbolic links)
| Tag  | Size | Description                                   |
|------+------+-----------------------------------------------|
| 'IP' | vary | item position: offset within file             |
| 'CP' | vary | content position: offset within content block |
| 'SZ' | vary | size in bytes of this piece of the file       |
** TODO implenet archive reader with an =entries()= for ~list~ subcommand
** TODO implement archive extraction
** TODO store, list, extract an entire directory tree
** DONE add =clap= for easier command line usage
** TODO remove read/write of =CA= tag (compression algo) from =FileEntry=
** TODO store (numeric) values using the least number of bytes
** TODO make metadata storage optional based on flags
** TODO check if compressed block is smaller, otherwise keep original data
** TODO store symbolic link value as file data
** TODO encrypt file data after compression
** TODO encrypt header rows
** TODO document the basic format
** develop library
*** create a reader and writer like the =tar= crate
*** optionally collect the extended attributes
* Reference
** comparison with other archivers
*** using httpd 2.4.59 source tree (3,138 files, 42,225,957 bytes)
| archiver | byte size | time      |
|----------+-----------+-----------|
| zip      |  12557798 | 0m1.458s  |
| tar.zst  |   8852419 | 0m0.379s  |
| pack-rs  |   8843264 | 0m0.529s  |
| Pack     |   8691712 | 0m0.244s  |
| tar.bz2  |   7540345 | 0m4.948s  |
| tar.xz   |   6464092 | 0m16.243s |
| 7-zip    |   6455217 |           |
** Compression algorithms for consideration
| Name  | Description              |
|-------+--------------------------|
| ZSTD  | ZStandard                |
| LZMA  | Improved version of LZ77 |
| LZMA2 | Improved version of LZMA |
| BZip2 | Standard BWT algorithm   |
| Copy  | No compression method    |
** Key derivation functions for consideration
*** from https://en.wikipedia.org/wiki/Key_derivation_function
: In 2013 a Password Hashing Competition was announced to choose a new,
: standard algorithm for password hashing. On 20 July 2015 the competition
: ended and Argon2 was announced as the final winner. Four other algorithms
: received special recognition: Catena, Lyra2, Makwa, and yescrypt. As of
: May 2023, OWASP recommends the following KDFs for password hashing, listed
: in order of priority:
- Argon2id
- scrypt if Argon2id is unavailable
- bcrypt for legacy systems
- PBKDF2 if FIPS-140 compliance is required
** Symmetric-key algorithms for consideration
- Twofish
- Serpent
- AES
- Camellia
- Salsa20
- ChaCha20
- Blowfish
- CAST5
- Kuznyechik
- RC4
- DES
- 3DES
- Skipjack
- Safer
- IDEA
* Alternatives
** Pack
*** https://github.com/PackOrganization/Pack
*** Zstandard compression, stored as blobs in SQLite
*** written in Pascal with custom built Zstandard and SQLite
** zip
*** https://users.cs.jmu.edu/buchhofp/forensics/formats/pkzip.html
*** flawed encryption, irregular entry structure due to organic growth
** tar
*** https://www.gnu.org/software/tar/manual/html_node/Standard.html
*** there is much overhead per entry
*** compression of whole file makes random access difficult
** 7-zip
*** https://www.7-zip.org
*** encrypted files can still have their contents listed
*** does not store file permissions
** xar
*** https://en.wikipedia.org/wiki/Xar_(archiver)
*** not widely available
