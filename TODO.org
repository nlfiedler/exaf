* Format
** Considerations
*** flexible, extensible format supporting optional fields of various lengths
*** records various metadata about files and directories if available from OS
*** numeric fields are network byte order (Big Endian)
*** textual fields are UTF-8 encoded
*** may include data checksums for verification
*** XML is flexible, supports complex data types
*** JSON is smaller than XML, easy to parse
*** EXIF style is compact (rows of tuples consisting of tag, size, value)
**** ~header rows~ will consist of 2-byte tag, 2-byte size, and N bytes of value
**** overall header size and individual rows will never be longer than 64 KB
*** CBOR is very compact but dependent on finding good implementations
** Encrytion
*** password is used to derive a key using one of various algorithms, typically with a salt
*** derived key (aka secret) is used to perform symmetric-key encryption on the file data
*** directory/file header data rows are encrypted to prevent listing of archive contents
** Archive header
*** EXIF style entries after the initial version-specific rows
| Offset | Size | Purpose                        |
|--------+------+--------------------------------|
|      0 |    4 | File signature ('EXAF')        |
|      4 |    2 | format version (major/minor)   |
|      6 |    2 | remaining header size in bytes |
|      8 |    2 | optional field tag             |
|     10 |    2 | optional field size in bytes   |
|     12 |    n | optional field value           |
|    ... |  ... | ...                            |
*** fields related to encryption
| Tag  | Purpose                                   |
|------+-------------------------------------------|
| 'KD' | key derivation algorithm (i.e. Argon2id)  |
| 'SA' | random salt for encrypting password       |
| 'IT' | number of iterations depending on KDF     |
| 'EA' | encryption algorithm (AES, Blowfish, etc) |
** Archive entry considerations
*** will need to ensure that any extended attributes are less than 64 KB
*** directory entries are optional, but must appear before files that refer to them
*** duplicate directory entries are permissible for easier addition of files
** Archive entry structure
*** all file paths and names are UTF-8 encoded
*** entry date/time is ~Unix time~ (seconds since the epoch) as 32 or 64 bits
**** https://en.wikipedia.org/wiki/Unix_time
**** length of the field will be either 4 (32 bits) or 8 (64 bits)
*** integer values will be serialized to the smallest number of bytes necessary
**** e.g. values below 256 will be written as 1 byte
*** each file and directory entry will consist several parts
| Name        | Size | Purpose                                 |
|-------------+------+-----------------------------------------|
| Header size | 2    | length of the header in bytes           |
| Header rows | N    | header rows as described below          |
*** each header row consists of 2 + 2 + N bytes (tag, size, value)
*** entry with row tag of =ID= is a directory while one with =SZ= is a file
*** encrypted archives will have their header rows encrypted, only size is unencrypted
** Archive entry representing a directory
*** codifies each unique path as a numeric value for efficiency
*** file entries will refer to the containing directory by its identifier
*** fields
| Tag  | Size   | Purpose                             | Required? |
|------+--------+-------------------------------------+-----------|
| 'ID' | vary   | Unique identifier                   | yes       |
| 'NM' | vary   | name of directory                   | yes       |
| 'PA' | vary   | parent path as UTF-8                |           |
| 'MO' | vary   | Unix mode                           |           |
| 'FA' | vary   | Windows file attributes             |           |
| 'MT' | 4 or 8 | modification date/time as Unix time |           |
| 'CT' | 4 or 8 | creation date/time as Unix time     |           |
| 'AT' | 4 or 8 | access date/time as Unix time       |           |
| 'XA' | vary   | Extended file system attributes     |           |
| 'UN' | vary   | name of FS owner                    |           |
| 'UI' | vary   | user identifier                     |           |
| 'GN' | vary   | name of FS group                    |           |
| 'GI' | vary   | group identifier                    |           |
*** example entry
| Tag  | Size | Value                        |
|------+------+------------------------------|
| 'MO' |    2 | 0o40755                      |
| 'ID' |    2 | 16344                        |
| 'PA' |   28 | node_modules/saml2-js/lib-js |
| 'MT' |    4 | 0x6604C3BF                   |
| 'UN' |    8 | nfiedler                     |
| 'UI' |    2 | 501                          |
| 'GN' |    5 | staff                        |
| 'GI' |    1 | 20                           |
** Archive entry representing a file
*** fields
| Tag  | Size   | Purpose                             | Required? |
|------+--------+-------------------------------------+-----------|
| 'NM' | vary   | name of file                        | yes       |
| 'SZ' | vary   | byte size of original data          | yes       |
| 'DI' | vary   | directory identifier                |           |
| 'MO' | vary   | Unix mode                           |           |
| 'FA' | vary   | Windows file attributes             |           |
| 'LN' | vary   | byte size of compressed data        |           |
| 'CA' | vary   | compression algorithm               |           |
| 'HA' | vary   | hash digest algorithm               |           |
| 'CS' | vary   | hash digest of original data        |           |
| 'MT' | 4 or 8 | modification date/time as Unix time |           |
| 'CT' | 4 or 8 | creation date/time as Unix time     |           |
| 'AT' | 4 or 8 | access date/time as Unix time       |           |
| 'XA' | vary   | Extended file system attributes     |           |
| 'UN' | vary   | user name                           |           |
| 'UI' | vary   | user identifier                     |           |
| 'GN' | vary   | group name                          |           |
| 'GI' | vary   | group identifier                    |           |
*** example entry
| Tag  | Size |                                      Value |
|------+------+--------------------------------------------|
| 'NM' |   16 |                           take_snapshot.rs |
| 'SZ' |    2 |                                      45130 |
| 'DI' |    2 |                                      16344 |
| 'MO' |    2 |                                   0o100644 |
| 'LN' |    2 |                                       7205 |
| 'CA' |    4 |                                     'LZMA' |
| 'HA' |    4 |                                     'SHA1' |
| 'CS' |   20 | 0xf29e0d471f31aca38e263720cb84ef5c7708a141 |
| 'MT' |    4 |                                 0x6604C3BF |
| 'UN' |    8 |                                   nfiedler |
| 'UI' |    2 |                                        501 |
| 'GN' |    5 |                                      staff |
| 'GI' |    1 |                                         20 |
* Action Plan
** consider how to batch compress many files like pack does
*** fill a buffer with file content, compress, write a header block, then write compressed data
*** archive format would look like this
1. archive header as usual
2. header of directories and files, size of compressed block
3. compressed block
4. (repeat 2 and 3...)
*** header structure
- 2-byte number of entries in this block (max 65535)
- 2-byte size of entry
- entry rows (tag, size, value)
- (repeat)
- 4-byte size of (compressed) data that follows
** remove the dictionary handling code
** add =clap= for easier command line usage
** make metadata storage optional based on flags
** check if compressed block is smaller, otherwise keep original data
** store symbolic link value as file data
** encrypt file data after compression
** document the basic format
** develop library
*** create a reader and writer like the =tar= crate
*** optionally collect the extended attributes
* Reference
** comparison with other archivers
*** using httpd 2.4.59 source tree (3,138 files, 42,225,957 bytes)
| archiver                       | output size |
|--------------------------------+-------------|
| exaf w/metadata                |    13109158 |
| exaf w/o metdata               |    12745782 |
| zip                            |    12514363 |
| exaf w/meta, 16k dict          |    12386265 |
| exaf no meta, 16k dict         |    12026176 |
| exaf w/meta, liblzma level 5   |    11980243 |
| exaf w/meta, liblzma level 9   |    11914867 |
| exaf w/meta, level 7, 16k dict |    11540062 |
| pack-2                         |     8691712 |
| tar.bz2                        |     7503198 |
| 7-zip                          |     6455217 |
** Compression algorithms for consideration
| Name  | Description              |
|-------+--------------------------|
| LZMA  | Improved version of LZ77 |
| LZMA2 | Improved version of LZMA |
| BZip2 | Standard BWT algorithm   |
| Copy  | No compression method    |
** Key derivation functions for consideration
*** from https://en.wikipedia.org/wiki/Key_derivation_function
: In 2013 a Password Hashing Competition was announced to choose a new,
: standard algorithm for password hashing. On 20 July 2015 the competition
: ended and Argon2 was announced as the final winner. Four other algorithms
: received special recognition: Catena, Lyra2, Makwa, and yescrypt. As of
: May 2023, OWASP recommends the following KDFs for password hashing, listed
: in order of priority:
- Argon2id
- scrypt if Argon2id is unavailable
- bcrypt for legacy systems
- PBKDF2 if FIPS-140 compliance is required
** Symmetric-key algorithms for consideration
- Twofish
- Serpent
- AES
- Camellia
- Salsa20
- ChaCha20
- Blowfish
- CAST5
- Kuznyechik
- RC4
- DES
- 3DES
- Skipjack
- Safer
- IDEA
* Alternatives
** Pack
*** https://github.com/PackOrganization/Pack
*** Zstandard compression, stored as blobs in SQLite
*** written in Pascal with custom built Zstandard and SQLite
** zip
*** https://users.cs.jmu.edu/buchhofp/forensics/formats/pkzip.html
*** flawed encryption, irregular entry structure due to organic growth
** tar
*** https://www.gnu.org/software/tar/manual/html_node/Standard.html
*** there is much overhead per entry
*** compression of whole file makes random access difficult
** 7-zip
*** https://www.7-zip.org
*** encrypted files can still have their contents listed
*** does not store file permissions
** xar
*** https://en.wikipedia.org/wiki/Xar_(archiver)
*** not widely available
